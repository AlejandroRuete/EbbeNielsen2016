---
title: "Ignorance Scores workflow: 2) Rasterize Observations"
author: "Alejandro Ruete"
date: "20 June 2016"
output: html_document
---

#require(leaflet)
#require(raster)
#require(maptools)

Once you downloaded species observations you need to summarize them in rasters. You may need to filter the data first seraching for duplicates, georeferencing issues, etc (REF to Stropp and Alavan). I cleaned fossils and kept only pbservations that identify the species. If you followed the first tutorial (link) or similar methods (QGIS plugin or GBIF exploration) you would have obtained a matrix with one row per observation whit three important variables, X and Y coordinates (for this exercize we will assume data is in WGS 84 decimal coordinates system), and species name. These columns may change labels depending on the data standar the file is (give examples). With the Following code you will create a spatial grid of the resolution you need (alt, use a grid you have), and summarize in two raster images the number of observations and number of species observed per grid cell. These are the two basic datasets you would need to produce the ignorance scores.

```{r Rasterize, eval=FALSE}
# Rasterize
require(raster)
data<-read.csv()
nd<-0.5 ## Degree 
r<-raster(nrows=180/nd, ncols=360/nd, xmn=-180, xmx=180, ymn=-90, ymx=90, 
       crs="+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs", vals=NULL)

# you need to provide a function 'fun' for when there are multiple points per cell
obs <- rasterize(all[, 5:4], r, field=all[,3], fun="count")

rich<- rasterize(all[, 5:4], r, field=all[,3], fun=function(x,...)length(unique(na.omit(x))))

require(leaflet)
leafletOutput("map", width="100%", height="100%"),
 output$map <- renderLeaflet({
    leaflet() %>%
      addTiles() %>%
      setView(lng = 0, lat = 0, zoom = 2) %>%
      addRasterImage(obs, opacity = 0.8)
  })
```

In some analysis portals (ANALYSPORTAL) or API calls not yet implemented in the mentioned packages (e.g.) you may directly get a file with these data where each row is a grid cell of the desired resolution. Still, to work with it you will need to create a raster from them. The following script help you with that. 

```{r, eval=FALSE, echo=TRUE}
library(raster)
library(maptools)
SweB10k<-readShapePoly("Z:/GIS DataBase/Sweden/Sweden_TerritorySWEREFF99 buffer10k.shp", proj4string=CRS("+proj=utm +zone=33 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"))
Amp <- read.csv("Z:/Artdatabanken/LifeWatch Observation Bias/Data/Amphibia/GridStatisticsOnSpeciesCounts (Amphibia).csv")
Buf <- read.csv("Z:/Artdatabanken/LifeWatch Observation Bias/Data/Amphibia/GridStatisticsOnSpeciesObservationCounts (Bufo bufo).csv")
Pel <- read.csv("Z:/Artdatabanken/LifeWatch Observation Bias/Data/Amphibia/GridStatisticsOnSpeciesObservationCounts (Pelophylax lessonae).csv")

y<-Amp
names(y)<-c("Id","Observation.count","X","Y","Grid.cell.width")
coordinates(y)<- ~ X + Y
# coerce to SpatialPixelsDataFrame
gridded(y) <- TRUE
# coerce to raster
tmp.rasterDF <- raster(y, layer=2, values=TRUE)
tmp.rasterDF <- mask(tmp.rasterDF,SweB10k)
writeRaster(tmp.rasterDF, paste("Z:/Artdatabanken/LifeWatch Observation Bias/Data/",namesTDF[i],sep=""), "GTiff")
```

